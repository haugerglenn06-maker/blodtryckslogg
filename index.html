<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Blodtrycks Logg</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<script src="./jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --primary:#2563eb;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --warn:#b91c1c;
  --ok:#15803d;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* Layout */
.container{
  max-width:720px;
  margin:0 auto;
  padding:16px 16px 96px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}

h1{text-align:center;margin-bottom:16px;}

/* Form */
.form{display:flex;flex-direction:column;gap:12px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:640px){.form-grid{grid-template-columns:1fr;}}

.field{display:flex;flex-direction:column;gap:4px;}
label{font-size:.75rem;color:var(--muted);}
input{
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
}

.form-actions{
  display:flex;
  justify-content:flex-end;
}
.form-actions button{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
}

/* Sticky save (mobil) */
.sticky-save{display:none;}
@media(max-width:640px){
  .form-actions{display:none;}
  .sticky-save{
    display:block;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#fff;
    border-top:1px solid var(--border);
    padding:12px 16px;
  }
  .sticky-save button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:8px;
    background:var(--primary);
    color:#fff;
  }
}

/* Controls */
.controls{
  display:grid;
  grid-template-columns:1fr 1fr auto auto auto;
  gap:8px;
  margin-bottom:12px;
}
@media(max-width:640px){
  .controls{grid-template-columns:1fr;}
  .controls button{width:100%;}
}

/* Logg */
.day-title{font-weight:600;margin:12px 0 4px;}
ul{list-style:none;padding:0;margin:0;}
li{padding:8px 0;border-bottom:1px solid var(--border);}
.value-ok{color:var(--ok);}
.value-warn{color:var(--warn);font-weight:600;}
.empty{text-align:center;color:var(--muted);}

/* Toast */
.toast{
  position:fixed;
  bottom:88px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  font-size:.85rem;
  opacity:0;
  pointer-events:none;
  transition:opacity .3s ease,transform .3s ease;
  z-index:1000;
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(-6px);
}

/* Print */
.print-title{display:none;font-weight:600;margin-bottom:12px;}
@media print{
  form,.controls,.sticky-save,footer,button{display:none!important;}
  body{background:#fff;}
  .card{border:none;padding:0;}
  .print-title{display:block;}
}

footer{
  text-align:center;
  color:var(--muted);
  font-size:.75rem;
  margin-top:24px;
}
</style>
</head>

<body>

<div class="container">
<h1>Blodtrycks Logg</h1>

<div class="card">
<form id="logForm" class="form">
  <div class="form-grid">
    <div class="field">
      <label>Tid</label>
      <input id="time" type="time" required>
    </div>
    <div class="field">
      <label>Systoliskt</label>
      <input id="systolic" type="number" required>
    </div>
    <div class="field">
      <label>Diastoliskt</label>
      <input id="diastolic" type="number" required>
    </div>
    <div class="field">
      <label>Puls</label>
      <input id="pulse" type="number" required>
    </div>
  </div>
  <div class="form-actions">
    <button type="submit">Spara</button>
  </div>
</form>
</div>

<div class="card">
  <div class="controls">
    <input id="fromDate" type="date">
    <input id="toDate" type="date">
    <button id="pdfBtn">Exportera PDF</button>
    <button id="csvBtn">Export CSV</button>
    <button id="backupBtn">Säkerhetskopiera</button>
  </div>

  <div id="printTitle" class="print-title"></div>
  <div id="logContainer"></div>
  <div id="emptyState" class="empty">Ingen logg sparad ännu</div>
</div>

<footer>Version 1.4.8 (PWA) · Skapad av Glenn Hauger © 2025</footer>
</div>

<div class="sticky-save">
  <button type="submit" form="logForm">Spara</button>
</div>

<div id="toast" class="toast">Värde sparat</div>

<script>
/* ===== DATA ===== */
const STORAGE_KEY='bloodpressure_logs';
const form=document.getElementById('logForm');
const container=document.getElementById('logContainer');
const emptyState=document.getElementById('emptyState');
const fromDateInput=document.getElementById('fromDate');
const toDateInput=document.getElementById('toDate');
const printTitle=document.getElementById('printTitle');

function loadLogs(){
  return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];
}
function saveLogs(logs){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(logs));
}
function getFiltered(){
  const f=fromDateInput.value;
  const t=toDateInput.value;
  return loadLogs().filter(l=>(!f||l.date>=f)&&(!t||l.date<=t));
}

/* ===== TOAST + HAPTIC ===== */
function showToast(msg){
  const toast=document.getElementById('toast');
  toast.textContent=msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1800);
}
function haptic(){
  if(navigator.vibrate) navigator.vibrate(30);
}

/* ===== RENDER ===== */
function render(logs=loadLogs()){
  container.innerHTML='';
  emptyState.style.display=logs.length?'none':'block';

  const grouped={};
  logs.forEach(l=>(grouped[l.date]=grouped[l.date]||[]).push(l));

  Object.keys(grouped).sort().reverse().forEach(date=>{
    const title=document.createElement('div');
    title.className='day-title';
    title.textContent=date;
    container.appendChild(title);

    const ul=document.createElement('ul');
    grouped[date].sort((a,b)=>a.time.localeCompare(b.time)).forEach(l=>{
      const li=document.createElement('li');
      li.innerHTML=`
        ${l.time} ·
        <span class="${l.systolic>=140?'value-warn':'value-ok'}">${l.systolic}</span> /
        <span class="${l.diastolic>=90?'value-warn':'value-ok'}">${l.diastolic}</span>
        · Puls <span class="${l.pulse>=100?'value-warn':'value-ok'}">${l.pulse}</span>
      `;
      ul.appendChild(li);
    });
    container.appendChild(ul);
  });
}

/* ===== SAVE ===== */
form.onsubmit=e=>{
  e.preventDefault();
  const logs=loadLogs();
  logs.unshift({
    date:new Date().toISOString().split('T')[0],
    time:time.value,
    systolic:systolic.value,
    diastolic:diastolic.value,
    pulse:pulse.value
  });
  saveLogs(logs);
  form.reset();
  document.activeElement.blur();
  window.scrollTo({top:0,behavior:'smooth'});
  haptic();
  showToast('Värde sparat');
  render();
};

/* ===== EXPORTS ===== */
document.getElementById('pdfBtn').onclick = async () => {
  try {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert('PDF-biblioteket kunde inte laddas');
      return;
    }

    const { jsPDF } = window.jspdf;
    const logs = getFiltered();

    if (!logs.length) {
      alert('Ingen data att exportera');
      return;
    }

    const from = fromDateInput.value || 'start';
    const to = toDateInput.value || 'idag';

    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    let y = 40;

    // Titel
    doc.setFontSize(16);
    doc.text(`Blodtryckslogg från ${from} till ${to}`, 40, y);
    y += 30;

    doc.setFontSize(10);

    let currentDate = '';
    logs.forEach(l => {
      if (l.date !== currentDate) {
        currentDate = l.date;
        y += 16;
        doc.setFont(undefined, 'bold');
        doc.text(currentDate, 40, y);
        doc.setFont(undefined, 'normal');
        y += 14;
      }

      doc.text(
        `${l.time}  ${l.systolic}/${l.diastolic} mmHg  Puls ${l.pulse}`,
        60,
        y
      );
      y += 14;

      if (y > 800) {
        doc.addPage();
        y = 40;
      }
    });

    const blob = doc.output('blob');
    const fileName = `blodtryckslogg_${from}_${to}.pdf`;
    const file = new File([blob], fileName, { type: 'application/pdf' });

    // Mobil (Share API med fil)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: 'Blodtryckslogg'
      });
    } else {
      // Desktop fallback
      doc.save(fileName);
    }

  } catch (err) {
    console.error(err);
    alert('Ett fel uppstod vid PDF-export');
  }
};

document.getElementById('csvBtn').onclick=()=>{
  const logs=getFiltered();
  if(!logs.length) return alert('Ingen data att exportera');
  let csv='Datum,Tid,Systoliskt,Diastoliskt,Puls\n';
  logs.forEach(l=>csv+=`${l.date},${l.time},${l.systolic},${l.diastolic},${l.pulse}\n`);
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='blodtryck_logg.csv';
  a.click();
};

document.getElementById('backupBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify(loadLogs(),null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='blodtryck_backup.json';
  a.click();
};

render();
</script>
</body>
</html>

